<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Step Commodity Swap Router - 1inch-Inspired</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .swap-interface {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .input-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .input-group select,
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group select:focus,
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .results-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            min-height: 200px;
        }

        .route-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .route-card.optimal {
            border: 3px solid #4caf50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .route-card.direct {
            border: 3px solid #2196f3;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .route-badge.optimal {
            background: #4caf50;
            color: white;
        }

        .route-badge.direct {
            background: #2196f3;
            color: white;
        }

        .route-badge.multi-step {
            background: #ff9800;
            color: white;
        }

        .route-path {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .commodity-box {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            white-space: nowrap;
        }

        .arrow {
            color: #667eea;
            font-size: 1.5em;
            margin: 0 15px;
            font-weight: bold;
        }

        .route-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .detail-label {
            color: #666;
            font-weight: 500;
        }

        .detail-value {
            color: #333;
            font-weight: 600;
        }

        .comparison-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #ffc107;
        }

        .comparison-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .improvement {
            color: #4caf50;
            font-weight: 700;
            font-size: 1.2em;
        }

        .test-scenarios {
            margin-top: 30px;
            padding: 25px;
            background: #e8f5e9;
            border-radius: 15px;
        }

        .test-scenarios h3 {
            color: #2e7d32;
            margin-bottom: 20px;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .scenario-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid #c8e6c9;
        }

        .scenario-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.2);
        }

        .scenario-name {
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 8px;
        }

        .scenario-details {
            font-size: 0.9em;
            color: #666;
        }

        .market-graph {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .market-graph h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .graph-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-color.large {
            background: #4caf50;
        }

        .legend-color.medium {
            background: #2196f3;
        }

        .legend-color.small {
            background: #ff9800;
        }

        .legend-color.currency {
            background: #ffd700;
        }

        .no-results {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 1.1em;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ef5350;
        }

        @media (max-width: 968px) {
            .swap-interface {
                grid-template-columns: 1fr;
            }

            .route-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🔄 Multi-Step Commodity Swap Router</h1>
            <p>1inch-Inspired Pathfinding for Optimal Exchange Routes</p>
        </header>

        <div class="content">
            <div class="swap-interface">
                <div class="input-section">
                    <h3>Swap Configuration</h3>
                    
                    <div class="input-group">
                        <label for="fromCommodity">From Commodity:</label>
                        <select id="fromCommodity">
                            <option value="">-- Select --</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="toCommodity">To Commodity:</label>
                        <select id="toCommodity">
                            <option value="">-- Select --</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="amount">Amount:</label>
                        <input type="number" id="amount" value="100" min="1" step="1">
                    </div>

                    <button class="btn" id="findRouteBtn">Find Optimal Route</button>
                </div>

                <div class="input-section">
                    <h3>Market Information</h3>
                    <div id="marketInfo">
                        <p style="color: #999; text-align: center; padding: 20px;">
                            Select commodities to view market information
                        </p>
                    </div>
                </div>
            </div>

            <div class="results-section" id="results">
                <div class="no-results">
                    Configure swap parameters and click "Find Optimal Route" to see results
                </div>
            </div>

            <div class="test-scenarios">
                <h3>📋 Test Scenarios (Click to Load)</h3>
                <div class="scenario-grid" id="scenarioGrid"></div>
            </div>

            <div class="market-graph">
                <h3>📊 Market Liquidity Overview</h3>
                <div class="graph-legend">
                    <div class="legend-item">
                        <div class="legend-color large"></div>
                        <span>Large Market (>700 volume)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color medium"></div>
                        <span>Medium Market (300-700 volume)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color small"></div>
                        <span>Small Market (<300 volume)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color currency"></div>
                        <span>Currency Pair (High Liquidity)</span>
                    </div>
                </div>
                <div id="marketPairsList"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { SwapRouter } from './js/swap-router.js';
        import { GameMarket, gameCommodities, marketPairs, testScenarios } from './js/game-commodities.js';

        // Initialize market
        const gameMarket = new GameMarket('test-market');
        const markets = { 'test-market': gameMarket };
        const swapRouter = new SwapRouter(markets);

        // Populate commodity dropdowns
        const fromSelect = document.getElementById('fromCommodity');
        const toSelect = document.getElementById('toCommodity');

        Object.values(gameCommodities).forEach(commodity => {
            const option1 = document.createElement('option');
            option1.value = commodity.id;
            option1.textContent = `${commodity.name} (${commodity.basePrice} cr)`;
            fromSelect.appendChild(option1);

            const option2 = document.createElement('option');
            option2.value = commodity.id;
            option2.textContent = `${commodity.name} (${commodity.basePrice} cr)`;
            toSelect.appendChild(option2);
        });

        // Populate test scenarios
        const scenarioGrid = document.getElementById('scenarioGrid');
        testScenarios.forEach((scenario, index) => {
            const card = document.createElement('div');
            card.className = 'scenario-card';
            card.innerHTML = `
                <div class="scenario-name">${scenario.name}</div>
                <div class="scenario-details">
                    ${gameCommodities[scenario.from].name} → ${gameCommodities[scenario.to].name}<br>
                    Amount: ${scenario.amount}
                </div>
            `;
            card.onclick = () => loadScenario(scenario);
            scenarioGrid.appendChild(card);
        });

        // Populate market pairs list
        const marketPairsList = document.getElementById('marketPairsList');
        const sortedPairs = Object.entries(marketPairs).sort((a, b) => b[1].volume - a[1].volume);
        
        sortedPairs.forEach(([pairKey, data]) => {
            const [first, second] = pairKey.split('-');
            const commodity1 = gameCommodities[first];
            const commodity2 = gameCommodities[second];
            
            let category = 'small';
            if (data.volume > 700) category = 'large';
            else if (data.volume > 300) category = 'medium';
            if (pairKey.includes('game-currency')) category = 'currency';
            
            const item = document.createElement('div');
            item.className = 'detail-item';
            item.innerHTML = `
                <span class="detail-label">
                    <span class="legend-color ${category}" style="display: inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 5px;"></span>
                    ${commodity1.name} ↔ ${commodity2.name}
                </span>
                <span class="detail-value">Vol: ${data.volume}, Spread: ${data.spreadPercent}%</span>
            `;
            marketPairsList.appendChild(item);
        });

        // Update market info when commodities are selected
        function updateMarketInfo() {
            const from = fromSelect.value;
            const to = toSelect.value;
            const marketInfo = document.getElementById('marketInfo');

            if (!from || !to) {
                marketInfo.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Select commodities to view market information</p>';
                return;
            }

            const fromCommodity = gameCommodities[from];
            const toCommodity = gameCommodities[to];
            const directMarket = gameMarket.hasDirectMarket(from, to);
            const marketDepth = directMarket ? gameMarket.getMarketDepth(from, to) : null;

            marketInfo.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong style="color: #667eea;">From:</strong> ${fromCommodity.name}<br>
                    <strong style="color: #667eea;">Current Price:</strong> ${gameMarket.getPrice(from)} cr
                </div>
                <div style="margin-bottom: 15px;">
                    <strong style="color: #667eea;">To:</strong> ${toCommodity.name}<br>
                    <strong style="color: #667eea;">Current Price:</strong> ${gameMarket.getPrice(to)} cr
                </div>
                <div style="padding: 10px; background: ${directMarket ? '#e8f5e9' : '#ffebee'}; border-radius: 5px;">
                    <strong>Direct Market:</strong> ${directMarket ? '✅ Available' : '❌ Not Available'}<br>
                    ${marketDepth ? `<small>Volume: ${marketDepth.volume}, Spread: ${marketDepth.spread}%</small>` : '<small>Must use multi-step routing</small>'}
                </div>
            `;
        }

        fromSelect.addEventListener('change', updateMarketInfo);
        toSelect.addEventListener('change', updateMarketInfo);

        // Find route button handler
        document.getElementById('findRouteBtn').addEventListener('click', findRoute);

        function findRoute() {
            const from = fromSelect.value;
            const to = toSelect.value;
            const amount = parseFloat(document.getElementById('amount').value);
            const resultsDiv = document.getElementById('results');

            if (!from || !to) {
                resultsDiv.innerHTML = '<div class="error-message">Please select both commodities</div>';
                return;
            }

            if (from === to) {
                resultsDiv.innerHTML = '<div class="error-message">Cannot swap a commodity with itself</div>';
                return;
            }

            // Refresh router with latest market data
            swapRouter.refresh();

            // Find optimal route
            const result = swapRouter.findOptimalRoute(from, to, amount);

            if (!result.success) {
                resultsDiv.innerHTML = `<div class="error-message">${result.error}</div>`;
                return;
            }

            // Display results
            displayResults(result);
        }

        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            const { optimalRoute, directRoute, comparison } = result;

            let html = '<h3 style="color: #667eea; margin-bottom: 20px;">Routing Results</h3>';

            // Optimal route
            html += `
                <div class="route-card optimal">
                    <div class="route-header">
                        <h4>Optimal Route</h4>
                        <span class="route-badge optimal">BEST OPTION</span>
                    </div>
                    <div class="route-path">
                        ${optimalRoute.path.map((c, i) => `
                            ${i > 0 ? '<span class="arrow">→</span>' : ''}
                            <div class="commodity-box">${gameCommodities[c].name}</div>
                        `).join('')}
                    </div>
                    <div class="route-details">
                        <div class="detail-item">
                            <span class="detail-label">Input Amount:</span>
                            <span class="detail-value">${result.inputAmount.toFixed(2)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Output Amount:</span>
                            <span class="detail-value">${optimalRoute.outputAmount.toFixed(2)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Number of Steps:</span>
                            <span class="detail-value">${optimalRoute.steps}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Total Cost Factor:</span>
                            <span class="detail-value">${optimalRoute.totalCost.toFixed(4)}</span>
                        </div>
                    </div>
                </div>
            `;

            // Direct route (if exists)
            if (directRoute) {
                html += `
                    <div class="route-card direct">
                        <div class="route-header">
                            <h4>Direct Route</h4>
                            <span class="route-badge direct">DIRECT</span>
                        </div>
                        <div class="route-path">
                            ${directRoute.path.map((c, i) => `
                                ${i > 0 ? '<span class="arrow">→</span>' : ''}
                                <div class="commodity-box">${gameCommodities[c].name}</div>
                            `).join('')}
                        </div>
                        <div class="route-details">
                            <div class="detail-item">
                                <span class="detail-label">Output Amount:</span>
                                <span class="detail-value">${directRoute.outputAmount.toFixed(2)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Cost Factor:</span>
                                <span class="detail-value">${directRoute.cost.toFixed(4)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Comparison
            html += `
                <div class="comparison-section">
                    <h4>💡 Recommendation</h4>
                    <p><strong>Strategy:</strong> ${comparison.useMultiStep ? 'Use Multi-Step Route' : 'Use Direct Route'}</p>
                    <p><strong>Reason:</strong> ${comparison.reason}</p>
                    ${comparison.improvement !== 'N/A%' ? `<p><strong>Improvement:</strong> <span class="improvement">${comparison.improvement}</span></p>` : ''}
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        function loadScenario(scenario) {
            fromSelect.value = scenario.from;
            toSelect.value = scenario.to;
            document.getElementById('amount').value = scenario.amount;
            updateMarketInfo();
            findRoute();
        }

        // Initialize market info
        updateMarketInfo();
    </script>
</body>
</html>
